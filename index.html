<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F√≠sica Batxillerat C-2022</title>

  <!-- Estil propi -->
  <link rel="stylesheet" href="theme.css">

  <!-- CSS ‚ÄúGitHub-like‚Äù per al markdown (opcional per√≤ recomanat) -->
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Baloo+2:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown-light.min.css">

  <!-- Marked (MD ‚Üí HTML) i DOMPurify (sanititzaci√≥) -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

  <!-- MathJax (LaTeX inline $...$ i bloc $$...$$) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['boldsymbol']}
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }   // ‚Üê clau: no fer typeset autom√†tic
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>

  <style>
    /* opcional: marges bonics per a f√≥rmules de bloc $$...$$ */
    .mjx-container[display="true"] { margin: 1em auto !important; }
  </style>
</head>
<body>
  
<!-- TOPBAR: selector de bloc + prev/next + cerca -->
  <header class="topbar">
    <div class="topbar-left">
      <label for="mdfile" class="sr-only">Obre un Bloc.md</label>
      <select id="mdfile" name="mdfile" class="topbar-select"></select>
      <button id="prevBtn" title="Anterior [">‚Üê</button>
      <button id="nextBtn" title="Seg√ºent ]">‚Üí</button>
    </div>
    <div class="topbar-right">
      <input id="quickFind" type="search" placeholder="Cerca en la p√†gina‚Ä¶ [/]" />
    </div>
  </header>

  <!-- LAYOUT amb barra lateral TOC + contingut -->
  <div class="layout">
    <aside class="sidebar">
      <nav id="toc"><!-- √çndex generat autom√†ticament --></nav>
    </aside>

    <main class="page">
      <article class="markdown-body card" id="content">
        <noscript>Cal JavaScript per renderitzar el Markdown.</noscript>
      </article>
    </main>
  </div>


  <script>
  // ‚Äî‚Äî‚Äî Llista de fitxers disponibles (edita segons els teus blocs) ‚Äî‚Äî‚Äî
  const DOCS = [
    { file: "c-2022-fisica.md", title: "C-2022 ‚Äî F√≠sica Batxillerat" },
    { file: "bloc0-matematiques.md", title: "Bloc 0 ‚Äî Matem√†tiques" },
    { file: "bloc1-cinematica.md", title: "Bloc 1 ‚Äî Cinem√†tica" },
    { file: "bloc4-camp-gravitatori.md", title: "Bloc 4 ‚Äî Camp Gravitatori" },
    { file: "tmp/ex-calcul-vectorial.md", title: "Ex 1 ‚Äî Calcul Vectorial" },
    // { file: "bloc2-dinamica.md",   title: "Bloc 2 ‚Äî Din√†mica"   },
  ];

  // ‚Äî‚Äî‚Äî Marked: enlla√ßos en pestanya nova, no trencar f√≥rmules ‚Äî‚Äî‚Äî
  const renderer = new marked.Renderer();
  const origLink = renderer.link.bind(renderer);
  renderer.link = (href, title, text) =>
    origLink(href, title, text).replace('<a ', '<a target="_blank" rel="noopener noreferrer" ');
  marked.setOptions({ gfm: true, breaks: false, mangle: false, headerIds: true, renderer });

  // ‚Äî‚Äî‚Äî Utils de query ‚Äî‚Äî‚Äî
  function getMDFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const name = params.get("md") || DOCS[0].file;
    return "md/" + name.replace(/^\/+/, "");
  }
  function setMDToQuery(name) {
    const url = new URL(window.location.href);
    url.searchParams.set("md", name);
    history.pushState({}, "", url);
  }

  // ‚Äî‚Äî‚Äî MathJax typeset segur ‚Äî‚Äî‚Äî
  async function typesetMath() {
    if (!window.MathJax) return;
    if (window.MathJax.startup?.promise) await window.MathJax.startup.promise;
    if (window.MathJax.typesetPromise) await window.MathJax.typesetPromise();
    else if (window.MathJax.typeset) window.MathJax.typeset();
  }

  // ‚Äî‚Äî‚Äî Construcci√≥ del TOC a partir de H1‚ÄìH3 ‚Äî‚Äî‚Äî
  function buildTOC() {
    const toc = document.getElementById("toc");
    toc.innerHTML = "";
    const headings = document.querySelectorAll("#content h1, #content h2, #content h3");
    headings.forEach(h => {
      const id = h.id || h.textContent.trim().toLowerCase().replace(/\s+/g, "-");
      if (!h.id) h.id = id;
      const a = document.createElement("a");
      a.href = `#${id}`;
      a.textContent = h.textContent.replace(/^#*\s*/, "");
      a.className = h.tagName === "H1" ? "lvl-1" : h.tagName === "H2" ? "lvl-2" : "lvl-3";
      toc.appendChild(a);
    });
  }

  // ‚Äî‚Äî‚Äî Cerca simple dins la p√†gina ‚Äî‚Äî‚Äî
  function quickFindNext(query) {
    if (!query) return;
    const el = document.getElementById("content");
    // Busca text pla; per simplicitat, fem scroll al primer match
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
    let node;
    query = query.toLowerCase();
    while ((node = walker.nextNode())) {
      const t = node.nodeValue.trim().toLowerCase();
      if (t && t.includes(query)) {
        const range = document.createRange();
        range.selectNodeContents(node.parentNode);
        const rect = range.getBoundingClientRect();
        window.scrollBy({ top: rect.top - 100, behavior: "smooth" });
        return;
      }
    }
  }

  // ‚Äî‚Äî‚Äî Carrega i renderitza ‚Äî‚Äî‚Äî
async function loadAndRender(mdPath) {
  try {
    const res = await fetch(mdPath, { cache: "no-store" });
    if (!res.ok) throw new Error(`No s'ha pogut carregar: ${mdPath}`);

    const md = await res.text();
    const html = DOMPurify.sanitize(marked.parse(md), { USE_PROFILES: { html: true } });
    const el = document.getElementById("content");
    el.innerHTML = html;

    // TOC + LaTeX
    buildTOC();
    await typesetMath();

  } catch (err) {
    const el = document.getElementById("content");

    // Si l'arxiu √©s el fitxer ignorat, mostra targeta d'examen
    if (mdPath.includes("ex-calcul-vectorial.md")) {
      el.innerHTML = `
        <div class="exam-card">
          <h2>üìò Avaluaci√≥ ‚Äî Unitat 1: Qu√® √©s la ci√®ncia?</h2>
          <p><strong>Data:</strong> dimecres 12 de novembre de 2025</p>
          <p><strong>Hora:</strong> 9:00 h</p>
          <p><strong>Aula:</strong> 2.3</p>
          <p class="muted">Recorda portar calculadora b√†sica i bol√≠graf blau o negre.</p>
          <hr>
          <p>Aquest recurs √©s intern del professorat i no est√† disponible al web.  
          L‚Äôavaluaci√≥ es far√† a classe en la data indicada.</p>
          <p><a href="./index.html">‚Üê Tornar a l‚Äôinici</a></p>
        </div>`;
    } else {
      // Missatge general per a la resta de fitxers
      el.innerHTML = `
        <div class="error">
          <strong>Error:</strong> ${err.message}
        </div>`;
    }
  }
}

  // ‚Äî‚Äî‚Äî Inicialitzaci√≥ UI ‚Äî‚Äî‚Äî
  const select = document.getElementById("mdfile");
  const prev = document.getElementById("prevBtn");
  const next = document.getElementById("nextBtn");
  const find = document.getElementById("quickFind");

  // Omple el selector amb DOCS
  function populateSelect() {
    select.innerHTML = DOCS.map(d => `<option value="${d.file}">${d.title}</option>`).join("");
  }

  function currentIndexByFile(file) {
    return DOCS.findIndex(d => d.file === file);
  }

  async function gotoFile(file) {
    setMDToQuery(file);
    select.value = file;
    await loadAndRender("md/" + file);
  }

  // Events
  select.addEventListener("change", () => gotoFile(select.value));
  prev.addEventListener("click", () => {
    const i = currentIndexByFile(select.value);
    if (i > 0) gotoFile(DOCS[i-1].file);
  });
  next.addEventListener("click", () => {
    const i = currentIndexByFile(select.value);
    if (i >= 0 && i < DOCS.length - 1) gotoFile(DOCS[i+1].file);
  });
  find.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); quickFindNext(find.value.trim()); }
  });

  // Dreceres: [ i ] per navegar; / per cercar
  window.addEventListener("keydown", (e) => {
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
    if (e.key === "/") { e.preventDefault(); find.focus(); return; }
    const i = currentIndexByFile(select.value);
    if (e.key === "[" && i > 0) { e.preventDefault(); gotoFile(DOCS[i-1].file); }
    if (e.key === "]" && i < DOCS.length - 1) { e.preventDefault(); gotoFile(DOCS[i+1].file); }
  });

  // Carrega inicial
  (async function init() {
    populateSelect();
    const mdPath = getMDFromQuery();                    // p.ex. "md/bloc0-matematiques.md"
    const file = mdPath.split("/").pop();               // p.ex. "bloc0-matematiques.md"
    // Si la query no coincideix amb DOCS, for√ßa el primer
    if (currentIndexByFile(file) === -1) {
      await gotoFile(DOCS[0].file);
    } else {
      select.value = file;
      await loadAndRender(mdPath);
    }
  })();

  // Recarrega en canvis d'historial (back/forward)
  window.addEventListener("popstate", () => loadAndRender(getMDFromQuery()));
</script>

</body>
</html>
